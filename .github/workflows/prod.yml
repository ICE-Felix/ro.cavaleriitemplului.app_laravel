name: Deploy on production

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: PROD

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install SSH client
      run: sudo apt-get update && sudo apt-get install -y openssh-client

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.DEPLOY_SERVER }} >> ~/.ssh/known_hosts
      shell: bash

    - name: Zip deployment files
      run: zip -r deployment.zip . -x "*.git*" "node_modules/*" "vendor/*" ".github/*"

    - name: Transfer files using SCP
      run: |
        scp -i ~/.ssh/id_rsa deployment.zip ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER }}:${{ secrets.DEPLOY_PATH }}

    - name: Unzip and Clean up on the server
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER }} "\
          cd ${{ secrets.DEPLOY_PATH }} && \
          unzip -o deployment.zip && \
          rm deployment.zip"
      shell: bash

    - name: Move configuration files and logs
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER }} "\
          cd ${{ secrets.DEPLOY_PATH }} && \
          mv ../.env . || echo '.env not found' && \
          mv ../.htaccess . || echo '.htaccess not found' && \
          [ -d ../storage/logs ] && mv ../storage/logs ./storage/ || echo 'No storage/logs to move'"
      shell: bash

    - name: Fix Laravel permissions
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER }} "\
          sudo mkdir -p ${{ secrets.DEPLOY_PATH }}/storage/logs ${{ secrets.DEPLOY_PATH }}/bootstrap/cache && \
          sudo chown -R www-data:www-data ${{ secrets.DEPLOY_PATH }}/storage ${{ secrets.DEPLOY_PATH }}/bootstrap/cache && \
          sudo chmod -R 775 ${{ secrets.DEPLOY_PATH }}/storage ${{ secrets.DEPLOY_PATH }}/bootstrap/cache"
      shell: bash

    - name: Install Node.js via NVM and run frontend build
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER }} "\
          export NVM_DIR=\$HOME/.nvm && \
          [ -s \$NVM_DIR/nvm.sh ] || (curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash) && \
          . \$NVM_DIR/nvm.sh && \
          nvm install 20 && \
          nvm use 20 && \
          cd ${{ secrets.DEPLOY_PATH }} && \
          npm install && \
          npm run build"
      shell: bash

    - name: Install PHP dependencies via Composer
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER }} "\
          cd ${{ secrets.DEPLOY_PATH }} && \
          composer install --no-interaction --prefer-dist --optimize-autoloader"
      shell: bash

    - name: Laravel post-deployment commands
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER }} "\
          cd ${{ secrets.DEPLOY_PATH }} && \
          php artisan migrate --force && \
          php artisan config:clear && \
          php artisan cache:clear && \
          php artisan config:cache && \
          php artisan route:cache && \
          php artisan view:cache"
      shell: bash

    - name: ✅ Deployment complete
      run: echo "✅ Laravel deployment to production completed successfully!"
