name: Deploy on production

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: PROD

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install SSH client
      run: sudo apt-get update && sudo apt-get install -y openssh-client

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.DEPLOY_SERVER }} >> ~/.ssh/known_hosts
      shell: bash

    - name: Archive deployment files
      run: zip -r deployment.zip . -x "*.git*" "node_modules/*" "vendor/*" ".github/*"

    - name: Transfer files to server
      run: |
        scp -i ~/.ssh/id_rsa deployment.zip ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER }}:${{ secrets.DEPLOY_PATH }}

    - name: Unzip and move config files
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER }} "\
          cd ${{ secrets.DEPLOY_PATH }} && \
          unzip -o deployment.zip && rm deployment.zip && \
          mv ../.env . || true && \
          mv ../.htaccess . || true"
      shell: bash

    - name: Fix Laravel permissions BEFORE composer install
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER }} "\
          cd ${{ secrets.DEPLOY_PATH }} && \
          sudo mkdir -p storage/logs bootstrap/cache && \
          sudo touch storage/logs/laravel.log && \
          sudo chown -R www-data:www-data storage bootstrap/cache && \
          sudo chmod -R 775 storage bootstrap/cache"
      shell: bash

    - name: Install PHP dependencies (composer)
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER }} "\
          cd ${{ secrets.DEPLOY_PATH }} && \
          composer install --no-interaction --prefer-dist --optimize-autoloader"
      shell: bash

    - name: Install Node.js and build frontend
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER }} "\
          export NVM_DIR=\$HOME/.nvm && \
          [ -s \$NVM_DIR/nvm.sh ] || (curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash) && \
          . \$NVM_DIR/nvm.sh && \
          nvm install 20 && nvm use 20 && \
          cd ${{ secrets.DEPLOY_PATH }} && \
          npm install && npm run build"
      shell: bash

    - name: Run Laravel post-deploy commands
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER }} "\
          cd ${{ secrets.DEPLOY_PATH }} && \
          php artisan config:clear && \
          php artisan cache:clear && \
          php artisan config:cache && \
          php artisan route:cache && \
          php artisan view:cache"
      shell: bash

    - name: ✅ Deployment completed
      run: echo "✅ Laravel deployment done without permission errors."
